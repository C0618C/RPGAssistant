<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Maker æ¸¸æˆé€šç”¨åŠ©æ‰‹</title>
    <script src="/../GameTools/jquery-3.6.0.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="gameSetting.js"></script>
    <style>
        @font-face {
            font-family: 'GameFont';
            src: url('è†å—éº¦åœ†ä½“.ttf');
        }

        * {
            font-family: 'GameFont';
            font-size: 20px;
        }

        body {
            color: #fff;
            background-color: #000;
            padding: 0 0;
            margin: 0 0;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }

        #gameInfo {
            display: flex;
            flex-direction: row;
            height: 100%;
        }

        #gameInfo .col {
            height: auto;
            border: 1px solid darkred;
            flex: 1;
            max-width: 45vw;
        }

        .bar {
            width: 100%;
            height: 10px;
            background-color: #555;
            position: relative;
        }

        .barValue {
            height: 100%;
            background-color: #fff;
        }

        .barValueText {
            color: #fff;
            text-align: center;
            position: absolute;
            top: 0px;
            right: 1px;
        }

        .stateTag {
            float: left;
            border: 1px solid #fff;
            padding: 2px 5px;
            margin-right: 5px;
            cursor: pointer;
        }

        .box {
            border-top: 2px solid darkred;
            margin-top: 10px;
        }

        .box h5 {
            text-align: center;
        }

        #itemInfo,
        #armorsInfo,
        #weaponsInfo,
        #playerInfo {
            display: flex;
            flex-wrap: wrap;
            padding: 2px 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        #playerInfo div {
            padding: 2px 8px;
        }

        .item,
        .armor,
        .weapon {
            border: 1px solid darkblue;
            padding: 2px 5px;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px;
            background-color: #eee;
            color: blueviolet;
            user-select: none;
        }

        .armor {
            color: rgb(149, 137, 8);
            border: 1px solid darkgreen;
        }

        .weapon {
            color: rgb(10, 149, 8);
            border: 1px solid darkgreen;
        }

        #toolsInfo {
            padding: 2px 8px;
            margin-bottom: 60px;
        }

        #toolsInfo button {
            color: darkred;
            font-size: 25px;
            padding: 5px 10px;
            margin: 5px 5px;
        }

        #switchesInfo .itemBox,
        #variablesInfo .itemBox {
            display: flex;
            flex-wrap: wrap;
            padding: 2px 15px;
            overflow-y: auto;
        }

        #switchesInfo,
        #variablesInfo {
            max-height: 89%;
            overflow-y: auto;
        }

        .itemBox {
            border-top: 1px solid rgb(90, 8, 8);
            border-bottom: 1px solid rgb(90, 8, 8);
        }

        .topItem .item {
            border: 1px solid gold;
        }

        .col h4 {
            text-align: center;
        }

        .showAction {
            background-color: #000;
            color: #fff;
            margin: 5px 5px;
            box-shadow: 2px 2px 8px darkred;
        }

        .TopWin {
            position: absolute;
            top: 10%;
            left: 25%;
            width: 50vw;
            height: 80vh;
            border: 1px solid darkred;
            background-color: #000;
            display: none;
            box-shadow: 5px 5px 25px darkred;
        }

        .TopWin h3 {
            text-align: center;
            height: 40px;
            border-bottom: 1px solid darkred;
        }

        .TopWin #TopWinContent {
            padding: 10px 20px;
            display: flex;
            justify-content: center
        }

        .TopWin #TopWinContent button {
            font-size: 24px;
            padding: 10px 20px;
            background-color: darkred;
            color: white;
            border: none;
            cursor: pointer;
        }

        .TopWin #TopWinContent * {
            font-size: 24px;
        }

        .checked::before {
            content: 'ğŸš©';
        }

        .questComplete {
            color: gray;
            text-decoration: line-through;
        }

        .questComplete::before {
            content: 'âœ…';
        }

        .questProcess {
            color: orange;
        }
    </style>
</head>

<body>
    <div id="loading" style="width: 100%;height: 100vh;display: flex;justify-content: center;align-items: center;">
        æ­£åœ¨æŸ¥æ‰¾æ¸¸æˆï¼Œè‹¥é•¿æœŸåœç•™æœ¬ç•Œé¢ï¼Œè¯·åˆ·æ–°æ¸¸æˆè¯•è¯•...</div>
    <div id="main" style="width: 100%;height: 100vh;display: none;">
        <h3 id="gameName"></h3>
        <div id="gameInfo">
            <!-- ç¬¬ä¸€åˆ— -->
            <div class="col" style="flex-grow: 0;flex-basis: min-content;overflow-y: auto;">
                <div id="actorInfo"></div>
                <div id="playerInfo" class="box" style="width: 400px;">
                    <div id="curMap">å½“å‰åœ°å›¾ï¼š</div>
                    <div id="coordinate">åæ ‡ï¼š</div><br />
                    <div id="gold" style="width: 100%;">ğŸª™é‡‘å¸ï¼š0</div>
                </div>
                <div class="box">
                    <h5>èƒŒåŒ…</h5>
                    <div id="itemInfo"></div>
                </div>
                <div class="box">
                    <h5>è£…å¤‡</h5>
                    <div id="weaponsInfo"></div>
                    <hr />
                    <div id="armorsInfo"></div>
                </div>
                <div class="box">
                    <div id="toolsInfo">
                        <button type="button" onclick="btGetItem()">è·å–ç‰©å“</button>
                        <button type="button" onclick="btGetWeapons()">è·å–æ­¦å™¨</button>
                        <button type="button" onclick="btGetArmors()">è·å–é˜²å…·</button>
                        <button type="button" onclick="btSetActorCount()">è§’è‰²æ•°é‡</button>
                        <button type="button" onclick="btSetPosition()">ç§»åŠ¨</button>
                        <button type="button" onclick="btSetScale()">ç¼©æ”¾</button>
                        <button type="button" onclick="btSetGold()">è·å¾—é‡‘å¸</button>
                        <button type="button">ä¹ å¾—æŠ€èƒ½</button>
                        <button type="button" onclick="btShowMapInfo()"><span
                                style="color:green;background-color: lightskyblue;">ğŸ—º</span>æŸ¥çœ‹æ‰€æœ‰åœ°å›¾ä¿¡æ¯</button>
                        <button type="button" onclick="btCheckQuests()">æŸ¥çœ‹ä»»åŠ¡</button>
                        <button type="button" onclick="btShowEvents()">æŸ¥çœ‹å½“å‰åœ°å›¾äº¤äº’ç‚¹</button>
                    </div>
                </div>
            </div>
            <div class="col">
                <h4>å˜é‡</h4>
                <div id="variablesInfo"></div>
            </div>
            <div class="col">
                <h4>å¼€å…³</h4>
                <div id="switchesInfo"></div>
            </div>
        </div>
    </div>

    <div id="TopWin" class="TopWin">
        <div style="float:right;margin-top:15px;margin-right: 15px;font-size: 25px;cursor: pointer;"
            onclick="$('#TopWin').hide()">Ã—</div>
        <h3 id="TopWinTitle">çª—å£æ ‡é¢˜</h3>
        <div id="TopWinContent"></div>
    </div>

    <script type="template" id="actorInfoTemplate">
                <div id="baseInfo_${actorIndex}" style="margin-bottom: 20px;">
                    <div>
                        <div id="actorLevel_${actorIndex}" style="float: right;margin-right:20px;cursor:pointer" onclick="btLevelUp(${actorId})"></div>
                        <div id="actorName_${actorIndex}" style="font-size:25px;"></div>
                    </div>
                    <table class="actorInfoTable">
                        <tr>
                            <td>&nbsp;HPï¼š</td>
                            <td class="bar">
                                <div class="barValue" id="hp_${actorIndex}" style="background-color: red;"></div>
                                <div class="barValueText" id="hpTxt_${actorIndex}"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;MPï¼š</td>
                            <td class="bar">
                                <div class="barValue" id="mp_${actorIndex}" style="background-color: blue;"></div>
                                <div class="barValueText" id="mpTxt_${actorIndex}"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;EXPï¼š</td>
                            <td class="bar">
                                <div class="barValue" id="exp_${actorIndex}" style="background-color: green;"></div>
                                <div class="barValueText" id="expTxt_${actorIndex}"></div>
                            </td>
                        </tr>
                        <tr>
                            <td>çŠ¶æ€:</td>
                            <td id="actorStates_${actorIndex}"></td>
                        </tr>
                    </table>
                </div>
    </script>
    <script type="text/javascript">
        // å…¨å±€ç³»ç»Ÿå˜é‡
        let GameId = null;
        let GameName = null;
        let GameData = null;        //æ¸¸æˆä¸­$datakå¼€å¤´çš„æ•°æ®
        let GameCacheData = {};        //æ¸¸æˆåŠ¨æ€æ•°æ®æœ€æ–°ç‰ˆæœ¬ç¼“å­˜
        // æ˜¾ç¤ºåœ¨é¡¶éƒ¨çš„å˜é‡å’Œå¼€å…³
        let DataShowTop = {
            var: new Set(),
            switch: new Set()
        };
        // ç¼©æ”¾é€‰é¡¹
        const SCALE_OPTIONS = [
            { value: 1.0, label: "100%" },
            { value: 1.25, label: "125%" },
            { value: 1.5, label: "150%", selected: "selected" },
            { value: 2.0, label: "200%" },
            { value: 2.15, label: "215%" },
            { value: 2.25, label: "225%" },
            { value: 2.5, label: "250%" }
        ];
        (function () {
            let socketClient = io();
            window.socketClient = socketClient;

            socketClient.on("GameEnd", (data) => {
                EndGame(data);
            });
            socketClient.on("CHECK_Result", (data) => {
                SelectGame(data);
            });
            socketClient.on("Answer_Data", (data) => {
                RenderData(data);
            });

            //ç³»ç»ŸçŠ¶æ€
            let _stateSelectGame = false;

            //è¿æ¥æ¸¸æˆ
            function ConnectGame() {
                if (GameId) {
                    InitGame();
                    return;
                }

                socketClient.emit("CHECK", "check");

                if (!_stateSelectGame) setTimeout(() => {
                    ConnectGame();
                }, 1000);
            }

            // é€‰æ‹©æ¸¸æˆ
            function SelectGame(data) {
                if (data.gameList.length === 1) {
                    GameId = data.gameList[0].id;
                    GameName = data.gameList[0].name;
                    console.log("å·²è½½å…¥æ¸¸æˆï¼š", GameName)
                    return;
                }
                _stateSelectGame = true;
                //TODOï¼šåšä¸€ä¸ªé€‰æ¸¸æˆçš„ç•Œé¢
                // for(let i = 0;i<data.gameList.length;i++){

                // }
            }

            //åˆå§‹åŒ–æ¸¸æˆ
            function InitGame() {
                $("#loading").hide();
                $("#main").show();
                $("#gameName").text(GameName);

                if (!GameData) {//åˆå§‹åŒ–æ•°æ®
                    GameData = {};
                    GetData("Variables", { handleType: "Cache" }, { varName: "$dataSystem.variables" });
                    GetData("Switches", { handleType: "Cache" }, { varName: "$dataSystem.switches" });
                    GetData("States", { handleType: "Cache" }, { varName: "$dataStates" });
                    GetData("Items", { handleType: "Cache" }, { varName: "$dataItems" });
                    GetData("Weapons", { handleType: "Cache" }, { varName: "$dataWeapons" });
                    GetData("Armors", { handleType: "Cache" }, { varName: "$dataArmors" });
                    GetData("Quests", { handleType: "Cache" }, { varName: "$dataQuests" });
                    GetData("Actors", { handleType: "Cache" }, { varName: "$dataActors" });
                    GetData("CustomData", { handleType: "Cache" }, { varName: "CustomData" });//æ¸¸æˆä¸ªæ€§åŒ–æ•°æ®
                    GetData("MapInfos", { handleType: "Cache" }, { varName: "$dataMapInfos" });
                    setTimeout(Update, 1000);
                }
            }

            function Update() {
                GetData("Actor", { format: ACTOR_DATA_FORMAT }, { count: ACTOR_COUNT });
                GetData("Item");
                GetData("Armor");
                GetData("Weapon");
                GetData("Gold");
                // GetData("Player");
                GetData("Coordinate");
                GetData("Variables");
                GetData("Switches");
                GetData("CurMapId", undefined, { varName: "$gameMap._mapId" });
                requestAnimationFrame(Update);
            }

            function EndGame(gameName) {
                if (gameName !== GameName) return;
                console.log("æ¸¸æˆä¸‹çº¿ï¼š", GameName);
                $("#loading").show();
                $("#main").hide();
                $("#TopWin").hide();
                GameId = null;
                GameName = null;
                GameData = null;
                GameCacheData = {};
                DataShowTop.var.clear();
                DataShowTop.switch.clear();
                ConnectGame();
            }

            ConnectGame();
        })();

        /**
         * è·å–æ•°æ®
         * @param {string} dataName æ•°æ®åç§°
         * @param {object} options é€‰é¡¹
         * @param {string} options.handleType å¤„ç†æ•°æ®çš„æ–¹å¼ï¼ŒRenderï¼šæ¸²æŸ“æ•°æ®ï¼ŒCacheï¼šç¼“å­˜æ•°æ®
         * @param {string} options.key æ•°æ®æ ‡è¯†ï¼Œä»…ç”¨äºUIåŒºåˆ†æ•°æ®ç±»å‹ï¼Œå¦‚"cache"åˆ™æ‰§è¡Œæ•°æ®ç¼“å­˜ã€‚
         * @param {string} options.format è·å–æ•°æ®çš„æ ¼å¼/é€”å¾„
         */
        function GetData(dataName, { handleType, key, format, cache } = { handleType: "Render", key: "", cache: true }, defaultData = {}) {
            if (cache !== false) cache = true;
            let data = {
                gameId: GameId,
                action: "GetData",
                type: dataName,
                handleType: handleType,    //å¤„ç†æ•°æ®çš„æ–¹å¼ï¼ŒRenderï¼šæ¸²æŸ“æ•°æ®ï¼ŒCacheï¼šç¼“å­˜æ•°æ®
                format: format,          //è·å–æ•°æ®çš„æ ¼å¼/é€”å¾„
                key: key,                    //æ•°æ®æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†åŒç±»å‹ã€ä¸åŒæ ¼å¼çš„æ•°æ®
                cache: cache,       //UIæ˜¯å¦ç¼“å­˜æ•°æ®
                ...defaultData
            };

            window.socketClient.emit("Ask_Data", data);
        }

        function ExecCMD(data) {
            let cmd = {
                ...data
            }
            window.socketClient.emit("ExecCMD", cmd);
        }

        function MoveTo(x, y, mapId = null) {
            if (!mapId) ExecCMD({
                cmd: "Move",
                type: "Position",
                x: x,
                y: y,
            });
            else ExecCMD({
                cmd: "Transfer",
                type: "NewMap",
                id: mapId,
                x: x,
                y: y,
                direction: 0,
                fadeType: 0,
            });
        }

        /**
         * æ›´æ–°UIâ€”â€”æ¸²æŸ“æ•°æ®
         * @param {object} data æ•°æ®
         */
        function RenderData(data) {
            if (data.handleType === "Cache") return CacheData(data);//ä»…éœ€ç¼“å­˜æ•°æ®ï¼Œæ— éœ€æ¸²æŸ“

            let oldData = [];
            //æ£€æŸ¥ç¼“å­˜
            if (data.cache) {
                let cacheData = JSON.stringify(data.data);
                if (GameCacheData[data.type] === cacheData) return;//æ•°æ®æœªæ”¹å˜ï¼Œæ— éœ€æ¸²æŸ“
                oldData = JSON.parse(GameCacheData[data.type] || "[]");
                GameCacheData[data.type] = cacheData;//æ›´æ–°ç¼“å­˜
            }

            if (!data.data && !data.err) return;
            switch (data.type) {
                case "Actor":
                    RenderActor(data.data);
                    break;
                case "Item":
                    RenderItem(data.data);
                    break;
                case "Armor":
                    RenderArmor(data.data);
                    break;
                case "Weapon":
                    RenderWeapon(data.data);
                    break;
                case "Gold":
                    $("#gold").text(`ğŸª™é‡‘å¸ï¼š${data.data || 0}`);
                    break;
                case "Coordinate":
                    $("#coordinate").text(`åæ ‡ï¼š(${data.data.x},${data.data.y})`);
                    break;
                case "Variables":
                    RenderVariables(data.data, oldData);
                    break;
                case "Switches":
                    RenderSwitches(data.data, oldData);
                    break;
                case "CurEvents":
                    ShowCurEvents(data.data);
                    break;
                case "Quests":
                    ShowQuests(data.data, data.err);
                    break;
                case "MapInfos":
                    ShowMapInfo(data.data);
                    break;
                case "CurMapId":
                    RenderCurMapInfo(data.data);
                    break;
            }
        }

        /**
         * æ¸²æŸ“è§’è‰²æ•°æ®
         * @param {object} data è§’è‰²æ•°æ®
         */
        function RenderActor(data) {
            if (!data) return;

            let template = $("#actorInfoTemplate").html();
            // console.log(template);

            let actorPlant = $("#actorInfo");
            actorPlant.empty();

            for (let i = 0; i < data.length; i++) {
                let data_i = data[i];
                if (!data_i) continue;
                let actorHtml = $(template.replace(/\${actorIndex}/g, i).replace(/\${actorId}/g, data_i._actorId));

                actorHtml.find(`#actorName_${i}`).text("ã€€" + data_i._name);
                actorHtml.find(`#actorLevel_${i}`).text(`Lv.${data_i._level}`);
                actorHtml.find(`#hp_${i}`).css("width", `${data_i._hp / data_i.mhp * 100}%`);
                actorHtml.find(`#mp_${i}`).css("width", `${data_i._mp / data_i.mmp * 100}%`);
                actorHtml.find(`#exp_${i}`).css("width", `${data_i._exp / data_i._maxExp * 100}%`);
                actorHtml.find(`#hpTxt_${i}`).text(`${data_i._hp}/${data_i.mhp}`);
                actorHtml.find(`#mpTxt_${i}`).text(`${data_i._mp}/${data_i.mmp}`);
                actorHtml.find(`#expTxt_${i}`).text(`${data_i._exp}/${data_i._maxExp}`);
                if (!data_i._maxExp) actorHtml.find(`#exp_${i}`).closest("tr").hide();

                //è®¾ç½®çŠ¶æ€
                if (data_i._states && GameData?.States) {
                    let stateBox = actorHtml.find(`#actorStates_${i}`);
                    for (let state of data_i._states) {
                        stateBox.append(`<div class="stateTag" title="${GameData.States[state].note}">${GameData.States[state].name}</div>`);
                    }
                }

                actorPlant.append(actorHtml);
            }
        }

        /**
         * æ¸²æŸ“ç‰©å“æ•°æ®
         * @param {object} data ç‰©å“æ•°æ®
         */
        function RenderItem(data) {
            let itemBag = $("#itemInfo");
            itemBag.empty();

            let bagHtml = "";
            for (let i = 0; i < data.length; i++) {
                let data_i = data[i];
                bagHtml += `<div class="item" title="${stringFormat(data_i.item.description, false)}_${data_i.item.note}">${data_i.item.name} x ${data_i.count}</div>`;
            }
            itemBag.html(bagHtml);
        }

        function RenderArmor(data) {
            let armorBag = $("#armorsInfo");
            armorBag.empty();

            let bagHtml = "";
            for (let i = 0; i < data.length; i++) {
                let data_i = data[i];
                bagHtml += `<div class="armor" title="${data_i.armor.description}_${data_i.armor.note}">${data_i.armor.name} x ${data_i.count}</div>`;
            }
            armorBag.html(bagHtml);
        }

        function RenderWeapon(data) {
            let armorBag = $("#weaponsInfo");
            armorBag.empty();

            let bagHtml = "";
            for (let i = 0; i < data.length; i++) {
                let data_i = data[i];
                bagHtml += `<div class="weapon" title="${data_i?.weapon?.description}_${data_i?.weapon?.note}">${data_i?.weapon?.name || ""} x ${data_i.count}</div>`;
            }
            armorBag.html(bagHtml);
        }

        function SetVarTop(i) {
            DataShowTop.var.add(i, i);
            let data = JSON.parse(GameCacheData.Variables || "[]");
            RenderVariables(data, data);
        }
        function SetVarTopDown(i) {
            DataShowTop.var.delete(i);
            let data = JSON.parse(GameCacheData.Variables || "[]");
            RenderVariables(data, data);
        }

        function RenderVariables(data, oldData) {
            if (!GameData?.Variables) return;
            let variablesBox = $("#variablesInfo");
            variablesBox.empty();
            let top = $("<div class='topItem itemBox'></div>");
            let itemBox = $("<div class='itemBox mainItemBox'></div>");

            let Variables = GameData.Variables;
            if (data.length > GameData.Variables.length)
                Variables = GameData.Variables.concat(new Array(data.length - GameData.Variables.length).fill("æœªè®¾å®šåå­—"));

            let bagHtml = "";
            for (let [i, v] of DataShowTop.var.entries()) {
                let css = '';
                if (oldData && data[i] != oldData[i]) css = `style="background-color:darkred;"`;
                bagHtml += `<div class="item showAction" ${css} title="${i}" onclick="ClickVariable(${i},'${data[i]}')" oncontextmenu="SetVarTopDown(${i});return false;">${Variables[i]} ï¼š${data[i]}</div>`;
            }
            if (bagHtml != "") {
                variablesBox.append(top);
                top.html(bagHtml);
            }
            bagHtml = "";
            for (let i = 0; i < Variables.length; i++) {
                let v = Variables[i];
                if (!v && !data[i]) continue;
                let css = ``;
                if (DataShowTop.var.has(i)) continue;
                if (oldData && data[i] != oldData[i]) css = `style="background-color:darkred;"`;
                bagHtml += `<div class="item showAction" ${css} title="${i}" onclick="ClickVariable(${i},'${data[i]}')" oncontextmenu="SetVarTop(${i});return false;">${v} ï¼š${data[i]}</div>`;
            }
            itemBox.html(bagHtml);
            variablesBox.append(itemBox);
        }

        function SetSwitchTop(i) {
            DataShowTop.switch.add(i, i);
            let data = JSON.parse(GameCacheData.Switches || "[]");
            RenderSwitches(data, data);
        }
        function SetSwitchTopDown(i) {
            DataShowTop.switch.delete(i);
            let data = JSON.parse(GameCacheData.Switches || "[]");
            RenderSwitches(data, data);
        }
        function RenderSwitches(data, oldData) {
            if (!GameData?.Switches) return;
            let switchesBox = $("#switchesInfo");
            switchesBox.empty();
            let top = $("<div class='topItem itemBox'></div>");
            let itemBox = $("<div class='itemBox mainItemBox'></div>");

            let Switches = GameData.Switches;
            if (data.length > GameData.Switches.length)
                Switches = GameData.Switches.concat(new Array(data.length - GameData.Switches.length).fill("æœªè®¾å®šåå­—"));

            let bagHtml = "";
            for (let [i, v] of DataShowTop.switch.entries()) {
                let css = "";
                if (oldData && data[i] != oldData[i]) css = `style="background-color:darkred;"`;
                bagHtml += `<div class="item showAction" ${css} title="${i}" onclick="ClickSwitch(${i})" oncontextmenu="SetSwitchTopDown(${i});return false;"><b>${Switches[i]} ï¼š${data[i]}</b></div>`;
            }
            if (bagHtml != "") {
                switchesBox.append(top);
                top.html(bagHtml);
            }
            bagHtml = "";
            for (let i = 0; i < Switches.length; i++) {
                let v = Switches[i];
                if (!v && !data[i]) continue;
                let css = ``;
                if (DataShowTop.switch.has(i)) continue;
                if (oldData && data[i] != oldData[i]) css = `style="background-color:darkred;"`;
                bagHtml += `<div class="item showAction" ${css} title="${i}" onclick="ClickSwitch(${i})" oncontextmenu="SetSwitchTop(${i});return false;"><b>${v} ï¼š${data[i]}</b></div>`;
            }
            itemBox.html(bagHtml);
            switchesBox.append(itemBox);
        }

        /**
         * æ¸²æŸ“å½“å‰åœ°å›¾åç§°
         * @param {number} mapId åœ°å›¾ID
         */
        function RenderCurMapInfo(mapId) {
            let mapUrl = [];
            let curMap = GameData.MapInfos[mapId];
            mapUrl.push(curMap.name);

            while (GameData.MapInfos[curMap.parentId]) {
                curMap = GameData.MapInfos[curMap.parentId];
                mapUrl.unshift(curMap.name);
            }

            $("#curMap").text(`å½“å‰åœ°å›¾ï¼š${mapUrl.join("/")}`);
        }

        /**
         * ç¼“å­˜æ•°æ®
         * @param {object} data ç¼“å­˜æ•°æ®
         */
        function CacheData(data) {
            GameData[data.type] = data.data;
        }

        function ClickVariable(index, data) {
            // alert(GameData.Variables[index]);
            SetGameValue({
                id: index,
                name: GameData.Variables[index],
                value: data,
                type: "Variable",
                showType: "æ¸¸æˆå˜é‡",
            })
        }

        function ClickSwitch(index, data) {
            // alert(GameData.Switches[index]);
            SetGameValue({
                id: index,
                name: GameData.Switches[index],
                value: data,
                type: "Switch",
                showType: "çŠ¶æ€å¼€å…³",
            })
        }

        function btLevelUp(actorIndex) {
            let actor = GameData.Actors[actorIndex];
            if (!actor) return;

            ExecCMD({
                cmd: "LevelUp",
                type: "Actor",
                id: actorIndex,
            });
        }

        /**
         * çª—å£ï¼šè·å–é˜²å…·
         */
        function btGetArmors() {
            let dom = $(`<div style="width:100%;height:100%;overflow:auto;display:flex;flex-wrap:wrap;color:darkyellow;"></div>`);
            dom.append(`<div style="width:100%;height:50px;font-size:24px;">é€‰å®šçš„é˜²å…·ï¼š<span id="selectedItemName" style="color:darkgoldenrod;"></span>
                <input id="selectedItemId" type="hidden" value="" />
                æ•°é‡ï¼š<input id="selectedCount" type="number" value="1" />
                <button type="button">è·å–é˜²å…·</button></div>`);
            let box = $(`<div style="width:100%;height:800px;overflow-y:auto;display:flex;flex-wrap:wrap;color:darkgreen;align-content: flex-start;"></div>`);
            dom.append(box);
            GameData.Armors[0] = { name: "å…¨é€‰", id: -1, description: "å…¨éƒ¨è·å–", note: "" };
            for (let i = 0; i < GameData.Armors.length; i++) {
                let item = GameData.Armors[i];
                if (!item) continue;
                if (!item.name) continue;

                let title = `${item.description}_${item.note}`;
                title = title.replace(/[>"]/g, "");
                let itemBar = $(`<div class="item" title="${title}" style="min-width:186px;color:darkgreen;text-align:center;font-size:24px;">${item.name}</div>`);
                itemBar.click(function () {
                    $("#selectedItemName").text(`${item.name} (${item.id})`);
                    $("#selectedItemId").val(item.id);
                });
                box.append(itemBar);
            }

            dom.find("button").click(function () {
                ExecCMD({
                    cmd: "Get",
                    type: "Armor",
                    id: parseInt($("#selectedItemId").val()),
                    count: parseInt($("#selectedCount").val()),
                });
                $("#TopWin").hide();
            });
            ShowTopWin("è·å–é˜²å…·", dom);
        }

        /**
         * çª—å£ï¼šè·å–æ­¦å™¨
         */
        function btGetWeapons() {
            let dom = $(`<div style="width:100%;height:100%;overflow:auto;display:flex;flex-wrap:wrap;color:darkyellow;"></div>`);
            dom.append(`<div style="width:100%;height:50px;font-size:24px;">é€‰å®šçš„æ­¦å™¨ï¼š<span id="selectedItemName" style="color:darkgoldenrod;"></span>
                <input id="selectedItemId" type="hidden" value="" />
                æ•°é‡ï¼š<input id="selectedCount" type="number" value="1" />
                <button type="button">è·å–æ­¦å™¨</button></div>`);
            let box = $(`<div style="width:100%;height:800px;overflow-y:auto;display:flex;flex-wrap:wrap;align-content: flex-start;"></div>`);
            dom.append(box);
            GameData.Weapons[0] = { name: "å…¨é€‰", id: -1, description: "å…¨éƒ¨è·å–", note: "" };
            for (let i = 0; i < GameData.Weapons.length; i++) {
                let item = GameData.Weapons[i];
                if (!item) continue;
                if (!item.name) continue;

                let title = `${item.description}_${item.note}`;
                title = title.replace(/[>"]/g, "");
                let itemBar = $(`<div class="item" title="${title}" style="min-width:186px;color:darkorange;text-align:center;font-size:24px;">${item.name}</div>`);
                itemBar.click(function () {
                    $("#selectedItemName").text(`${item.name} (${item.id})`);
                    $("#selectedItemId").val(item.id);
                });
                box.append(itemBar);
            }

            dom.find("button").click(function () {
                // ACTOR_COUNT = parseInt(dom.find("#actorCount").val());
                ExecCMD({
                    cmd: "Get",
                    type: "Weapon",
                    id: parseInt($("#selectedItemId").val()),
                    count: parseInt($("#selectedCount").val()),
                });
                $("#TopWin").hide();
            });
            ShowTopWin("è·å–æ­¦å™¨", dom);
        }

        /**
         * çª—å£ï¼šè·å–ç‰©å“
         */
        function btGetItem() {
            let dom = $(`<div style="width:100%;height:100%;overflow:auto;display:flex;flex-wrap:wrap;color:darkyellow;"></div>`);
            dom.append(`<div style="width:100%;height:50px;font-size:24px;">é€‰å®šçš„ç‰©å“ï¼š<span id="selectedItemName" style="color:darkgoldenrod;"></span>
                <input id="selectedItemId" type="hidden" value="" />
                æ•°é‡ï¼š<input id="selectedCount" type="number" value="1" />
                <button type="button">è·å–ç‰©å“</button></div>`);
            let box = $(`<div style="width:100%;height:800px;overflow-y:auto;display:flex;flex-wrap:wrap;align-content: flex-start;"></div>`);
            dom.append(box);
            GameData.Items[0] = { name: "å…¨é€‰", id: -1, description: "å…¨éƒ¨è·å–", note: "" };
            for (let i = 0; i < GameData.Items.length; i++) {
                let item = GameData.Items[i];
                if (!item) continue;
                if (!item.name) continue;
                let fColor = "black";
                if (item.name.includes("è¯") || item.name.includes("å‰‚")) fColor = "darkgreen";
                else if (item.name.includes("é’¥åŒ™")) fColor = "orangered";
                else if (item.name.includes("æ§åˆ¶")) fColor = "darkred";

                let title = `${item.description}_${item.note}`;
                title = title.replace(/[>"]/g, "");
                let itemBar = $(`<div class="item" title="${title}" style="min-width:186px;color:${fColor};text-align:center;font-size:24px;">${item.name}</div>`);
                itemBar.click(function () {
                    $("#selectedItemName").text(`${item.name} (${item.id})`);
                    $("#selectedItemId").val(item.id);
                });
                box.append(itemBar);
            }

            dom.find("button").click(function () {
                // ACTOR_COUNT = parseInt(dom.find("#actorCount").val());
                ExecCMD({
                    cmd: "Get",
                    type: "Item",
                    id: parseInt($("#selectedItemId").val()),
                    count: parseInt($("#selectedCount").val()),
                });
                $("#TopWin").hide();
            });
            ShowTopWin("è·å–ç‰©å“", dom);
        }

        /**
         * çª—å£ï¼šè®¾ç½®è§’è‰²æ•°é‡
         */
        function btSetActorCount() {
            let dom = $(`
                <div>è¯·è¾“å…¥è§’è‰²æ•°é‡ï¼š<input id="actorCount" type="number" value="${ACTOR_COUNT}"">
                    <button type="button">è®¾ç½®</button>
                </div>
            `);
            dom.find("button").click(function () {
                ACTOR_COUNT = parseInt(dom.find("#actorCount").val());
                $("#TopWin").hide();
            });
            ShowTopWin("è®¾ç½®è§’è‰²æ•°é‡", dom, {
                top: "35%",
                left: "25%",
                width: "50vw",
                height: "30vh",
            });
        }

        /**
         * çª—å£ï¼šè®¾ç½®ç¼©æ”¾å€¼
         */
        function btSetScale() {
            let dom = $(`
                <div style="width:100%;height:100%;padding:20px;color:darkyellow;">
                    <div style="margin-bottom:20px;">
                        <label for="scaleSelect">é€‰æ‹©ç¼©æ”¾æ¯”ä¾‹ï¼š</label>
                        <select id="scaleSelect" style="padding:5px;margin-left:10px;color:darkred;">
                            ${SCALE_OPTIONS.map(option => `<option value="${option.value}" ${option.selected || ""}>${option.label}</option>`).join('')}
                        </select>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label for="customScale">æˆ–è¾“å…¥è‡ªå®šä¹‰ç¼©æ”¾å€¼ï¼š</label>
                        <input id="customScale" type="number" step="0.1" min="1.0" max="5.0" value="${SCALE_OPTIONS.find(opt => opt.selected).value}"
                               style="padding:5px;margin-left:10px;width:80px;color:darkred;" 
                               placeholder="1.0">
                    </div>
                    <div style="text-align:center;">
                        <button type="button">åº”ç”¨ç¼©æ”¾</button>
                    </div>
                </div>
            `);

            // å½“ä¸‹æ‹‰é€‰æ‹©æ”¹å˜æ—¶ï¼Œæ›´æ–°è‡ªå®šä¹‰è¾“å…¥æ¡†
            dom.find("#scaleSelect").change(function () {
                const selectedValue = $(this).val();
                dom.find("#customScale").val(selectedValue);
            });

            // å½“è‡ªå®šä¹‰è¾“å…¥æ¡†æ”¹å˜æ—¶ï¼Œæ›´æ–°ä¸‹æ‹‰é€‰æ‹©
            dom.find("#customScale").on('input', function () {
                const customValue = parseFloat($(this).val());
                const select = dom.find("#scaleSelect");
                const option = SCALE_OPTIONS.find(opt => opt.value === customValue);

                if (option) {
                    select.val(customValue);
                } else {
                    select.val(''); // æ¸…é™¤é€‰æ‹©ï¼Œè¡¨ç¤ºè‡ªå®šä¹‰å€¼
                }
            });

            dom.find("button").click(function () {
                let scaleValue = parseFloat(dom.find("#customScale").val());

                // éªŒè¯è¾“å…¥å€¼
                if (isNaN(scaleValue) || scaleValue < 0.1 || scaleValue > 5.0) {
                    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç¼©æ”¾å€¼ï¼ˆ1.0 - 5.0ï¼‰");
                    return;
                }

                // å‘é€ç¼©æ”¾å‘½ä»¤
                ExecCMD({
                    cmd: "Scale",
                    scale: scaleValue
                });

                $("#TopWin").hide();
            });

            ShowTopWin("è®¾ç½®ç¼©æ”¾", dom, {
                top: "30%",
                left: "30%",
                width: "40vw",
                height: "40vh",
            });
        }

        function btSetPosition() {
            let coordinate = JSON.parse(GameCacheData["Coordinate"] || "{}");
            let dom = $(`
                <div>è¯·è¾“å…¥ä½ç½®ï¼š<br/>
                    Xï¼š<input id="positionX" type="text" value="${coordinate.x}"><br/>
                    Yï¼š<input id="positionY" type="text" value="${coordinate.y}">
                    <br/><br/><button type="button">ç§»åŠ¨</button>
                </div>
            `);
            dom.find("button").click(function () {
                MoveTo(parseInt(dom.find("#positionX").val()), parseInt(dom.find("#positionY").val()));
                $("#TopWin").hide();
            });
            ShowTopWin("è®¾ç½®ä½ç½®", dom, {
                top: "35%",
                left: "25%",
                width: "50vw",
                height: "30vh",
            });
        }

        function btSetGold() {
            let goldCount = JSON.parse(GameCacheData["Gold"] || "0");
            let dom = $(`
                <div>è¯·è¾“å…¥é‡‘å¸æ•°é‡ï¼š<input id="goldCount" type="number" value="${goldCount}"">
                    <button type="button">è®¾ç½®</button>
                </div>
            `);
            dom.find("button").click(function () {
                goldCount = parseInt(dom.find("#goldCount").val());
                ExecCMD({
                    cmd: "Set",
                    type: "Gold",
                    value: goldCount,
                });
                $("#TopWin").hide();
            });
            ShowTopWin("è®¾ç½®é‡‘å¸æ•°é‡", dom, {
                top: "35%",
                left: "25%",
                width: "50vw",
                height: "30vh",
            });
        }

        /**
         * æ˜¾ç¤ºå½“å‰åœ°å›¾çš„å¯äº¤äº’å¯¹è±¡
         */
        function btShowEvents() {
            GetData("CurEvents", { cache: false });
        }
        function ShowCurEvents(events) {
            let dom = $(`
                <div style="display:flex;flex-wrap:wrap;align-content: flex-start;overflow-y:auto;height:800px;">
                    ${events.map(event => `<button type="button" style="margin:5px 5px;" onclick="MoveTo(${event.x}, ${event.y})" title="${event.note}">${event.name}ï¼š${event.x}ï¼Œ${event.y}</button>`).join("")}
                </div>
            `);
            ShowTopWin("å½“å‰åœ°å›¾å¯äº¤äº’å¯¹è±¡", dom);
        }

        /**
         * æ£€æŸ¥ä»»åŠ¡ç³»ç»Ÿ
         */
        function btCheckQuests() {
            if (!GameData["Quests"]) {
                alert("æ²¡æœ‰ä»»åŠ¡ç³»ç»Ÿ");
                return;
            }
            GetData("Quests", { cache: false });
        }
        function ShowQuests(quests, err) {
            if (quests?.data.length == 0 || err) {
                alert("æ²¡æœ‰ä»»åŠ¡ç³»ç»Ÿ");
                return;
            }
            let dom = $(`<div style="display:flex;flex-wrap:wrap;align-content: flex-start;overflow-y:auto;height:800px;width:100%"></div>`);

            //ä»»åŠ¡çº¿æŒ‰é’®
            let questLine = GameData["Quests"][0];  //ä»»åŠ¡çº¿åºåˆ—
            let qLDom = $(`<div style="display:flex;flex-wrap:no-wrap;align-content: flex-start;overflow-y:auto;"></div>`);
            //ä»»åŠ¡åˆ—è¡¨
            let qBody = $(`<div style="display:flex;flex-wrap:wrap;align-content: flex-start;overflow-y:auto;width:100%"></div>`);
            let qItemDom = $(`<div style="min-height:600px;overflow-y:auto;border:1px dashed #400;width:400px;flex-grow:0;"></div>`);
            let qShowDom = $(`<div style="min-height:600px;overflow-y:auto;border:1px solid #400;flex-grow:2;padding:20px 20px;"></div>`);

            //åˆ‡æ¢ä»»åŠ¡çº¿
            for (let i = 0; i < questLine.length; i++) {
                let quest_i = questLine[i];
                if (!quest_i) continue;
                let qList = $(`<ul class='qList' style="display:none;padding-left:unset;list-style-type:none;"></ul>`);
                let thisQuest = GameData["Quests"].filter(quest => quest?.cat == i && quest?.name != "<Name>");//TODO:ä¸æ¸¸æˆè®¾è®¡ç›¸å…³ä¸åŒä½œè€…çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·
                let curQuest = quests.data.filter(quest => quest?.cat == i);//å½“å‰è¿›è¡Œä¸­/å·²å®Œæˆä»»åŠ¡çš„æ•°æ®

                for (let j = 0; j < thisQuest.length; j++) {
                    let quest_j = thisQuest[j];
                    let isThisQuest = curQuest.find(q => q?.questId == quest_j.id)
                    let status = "";
                    if (isThisQuest?.status == "completed") status = "color:green;"
                    else if (isThisQuest?.status == "progress") status = "color:red;"
                    let qTask = $(`<li id="quest_${quest_j.id}" style="${status}padding:8px 5px;border:1px solid #400;text-align:center;cursor:pointer;">${quest_j.id}:${stringFormat(quest_j.name, false)}</li>`);
                    qTask.on("click", function () {//ç‚¹å‡»ä»»åŠ¡åç§°ï¼ŒæŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
                        qShowDom.empty();
                        qItemDom.find(".checked").removeClass("checked");//å–æ¶ˆé€‰ä¸­
                        qTask.addClass("checked");//æ·»åŠ é€‰ä¸­æ ·å¼
                        qShowDom.append(`<h2>${stringFormat(quest_j.name, false)}</h2><p>${stringFormat(quest_j.desc)}</p><hr style="border-color:#a55;" />`);
                        //ä»»åŠ¡è¿›åº¦åˆ¤æ–­
                        let questInStep = quests.data.find(q => q?.questId == quest_j.id);
                        let curStepId = questInStep?.currentStep || -1;

                        let qStepDom = $(`<ol style="padding-left:20px;margin-left:50px;color:#ccc;"></ol>`);
                        for (let k = 0; k < quest_j.steps.length; k++) {
                            let task_k = quest_j.steps[k][0];
                            let showStyle = "";
                            if (k < curStepId || questInStep?.status == "completed") showStyle = "questComplete";
                            else if (k == curStepId) showStyle = "questProcess checked";
                            else showStyle = "";
                            qStepDom.append(`<li class="${showStyle}" style="padding:5px 5px;">${stringFormat(task_k)}</li>`);
                        }
                        qShowDom.append(qStepDom);
                    });
                    qList.append(qTask);
                }

                let qBtn = "";
                if (thisQuest.length > 0) {
                    qItemDom.append(qList);
                    qBtn = $(`<button type="button" id="cat_${i}" ${thisQuest.length == 0}>${quest_i}</button>`);
                    qBtn.on("click", function () {//ç‚¹å‡»ä»»åŠ¡çº¿æŒ‰é’®
                        dom.find(`.qList`).hide();
                        qLDom.find(".checked").removeClass("checked");//å–æ¶ˆé€‰ä¸­
                        qItemDom.find(".checked").removeClass("checked");//å–æ¶ˆé€‰ä¸­
                        qBtn.addClass("checked");//æ·»åŠ é€‰ä¸­æ ·å¼
                        qShowDom.empty();
                        qList.show();
                    });
                } else {
                    qBtn = $(`<button type="button" id="cat_${i}" disabled style="cursor:not-allowed;background-color:lightgray;">${quest_i}</button>`);
                }
                qLDom.append(qBtn);
            }
            dom.append(qLDom);

            qBody.append(qItemDom);
            qBody.append(qShowDom);
            dom.append(qBody);

            //åˆ‡æ¢å½“å‰ä»»åŠ¡
            let showQuest = quests.data.filter(quest => quest?.status == "progress");
            if (showQuest.length > 0) {
                let p = showQuest.pop();
                dom.find(`#cat_${p.cat}`).trigger("click");
                dom.find(`#quest_${p.questId}`).trigger("click");
            } else {
            }

            ShowTopWin("ä»»åŠ¡åˆ—è¡¨", dom, {
                top: "5%",
                left: "5%",
                width: "90vw",
                height: "90vh",
            });
        }

        /**
         * æ˜¾ç¤ºæ‰€æœ‰æ³¨å†Œçš„åœ°å›¾
         */
        function btShowMapInfo() {
            if (GameCacheData["MapInfos"]) ShowMapInfo(JSON.parse(GameCacheData["MapInfos"]));
            else GetData("MapInfos");
        }
        function ShowMapInfo(mapInfo) {
            //ç¼“å­˜æ‰€æœ‰åœ°å›¾
            let bt = $("<button>ç¼“å­˜æ‰€æœ‰åœ°å›¾</button>");
            bt.on("click", () => { ExecCMD({ cmd: "CacheAllMap" }); });
            let dom = $(`<div style="display:flex;flex-wrap:wrap;align-content:flex-start;align-items:flex-start;overflow-y:auto;height:800px;"></div>`);//$gamePlayer.reserveTransfer(mapId, x, y, direction, fadeType)
            let mapIdSet = new Set(mapInfo.map(map => map?.id));
            mapIdSet.delete(undefined);
            let curMapId = parseInt(GameCacheData.CurMapId);
            //æ‰€æœ‰æˆ¿é—´å…¥å£
            let renderMap = function (mapId, rootDom, titleSize = 2) {
                let mapRoots = mapInfo.filter(map => map?.parentId === mapId);
                for (let i = 0; i < mapRoots.length; i++) {
                    let mapRoot_i = mapRoots[i];
                    mapIdSet.delete(mapRoot_i.id);
                    let mapDom = $(`<div class="mapBox" style="display:flex;flex-wrap: wrap;align-items:flex-start;margin:10px 10px;padding:5px 5px;border:1px solid #400;flex-grow:1;background-color:#${"".padEnd(3, titleSize.toString())}">
                        <h${Math.min(titleSize, 6)} onclick="MoveTo(${6}, ${6},${mapRoot_i.id})" style="cursor:pointer;width:100%;">${mapRoot_i.id}&nbsp;${mapRoot_i.name}</h${Math.min(titleSize, 6)}>
                    </div>`);
                    if (mapRoot_i.id == curMapId) mapDom.css("backgroundColor", "darkred");
                    rootDom.append(mapDom);
                    renderMap(mapRoot_i.id, mapDom, titleSize + 1);
                }
            }
            renderMap(0, dom);//æ³¨æ„ä»¥0ä¸ºæ ¹åœ°å›¾
            while (mapIdSet.size > 0) {
                let mapId = mapIdSet.values().next().value;
                mapIdSet.delete(mapId);
                let mapDom = $(`<div class="mapBox" style="display:flex;flex-wrap: wrap;align-items:flex-start;margin:10px 10px;padding:5px 5px;border:1px solid #400;flex-grow:1;background-color:#eee">
                    <h${Math.min(titleSize, 6)} onclick="MoveTo(${6}, ${6},${mapId})" style="cursor:pointer;width:100%;">${mapId}&nbsp;${mapInfo.find(map => map?.id == mapId)?.name}</h${Math.min(titleSize, 6)}>
                </div>`);
                renderMap(mapId, mapDom);
                dom.append(mapDom);
            }

            dom.children(".mapBox").css("border", "2px solid darkred");

            ShowTopWin("æ‰€æœ‰æ³¨å†Œçš„åœ°å›¾", dom, {
                top: "10%",
                left: "10%",
                width: "80vw",
                height: "80vh"
            });
            dom.before(bt);
        }

        /**
         * è®¾ç½®æ¸¸æˆæ•°æ®
         * @param {object} option é€‰é¡¹
         * @param {string} option.name æ•°æ®åç§°
         * @param {string} option.value æ•°æ®å€¼
         * @param {string} option.type æ•°æ®ç±»å‹
         */
        function SetGameValue(option) {
            let dom = $(`<div><table><tr>
                <td>${option.name}ï¼š</td><td><input id="tempValue" type="text" value="${option.value}""></td></tr>
                <tr><td>æ•°æ®ç±»å‹ï¼š</td><td>
                    <input type="radio" name="dataType" value="Number" id="dataTypeNumber"><label for="dataTypeNumber">æ•°å­—</label>
                    <input type="radio" name="dataType" value="String" id="dataTypeString"><label for="dataTypeString">å­—ç¬¦ä¸²</label>
                    <input type="radio" name="dataType" value="Boolean" ${option.type == "Switch" ? "checked" : ""} id="dataTypeBoolean">
                    <label for="dataTypeBoolean">å¸ƒå°”å€¼</label>
                </td></tr>
                <tr><td></td><td>
                    <button type="button">è®¾ç½®</button>
                </td></tr>
            </table></div>`);
            dom.find("button").click(function () {
                let dataType = dom.find("input[name='dataType']:checked").val();
                let value = dom.find("#tempValue").val();
                if (dataType == "Number") value = parseInt(value);
                else if (dataType == "Boolean") value = (value == "true" || value > 0);

                ExecCMD({
                    cmd: "Set",
                    type: option.type,
                    value: value,
                    id: option.id,
                });
                $("#TopWin").hide();
            });
            ShowTopWin(`è®¾ç½®${option.showType} - ã€Š${option.name}ã€‹`, dom, {
                top: "35%",
                left: "25%",
                width: "50vw",
                height: "40vh",
            });
        }
        /**z
         * æ˜¾ç¤ºé¡¶éƒ¨çª—å£
         * @param {string} title çª—å£æ ‡é¢˜
         * @param {string} content çª—å£å†…å®¹
         */
        function ShowTopWin(title, content, options = {
            top: "10%",
            left: "25%",
            width: "50vw",
            height: "80vh",
        }) {
            $("#TopWinTitle").text(title);
            $("#TopWinContent").empty().append(content);
            $("#TopWin").css(options).show();
        }

        function stringFormat(str, withMark = true) {
            if (/\\N\[\d+\]/.test(str)) {
                str = str.replace(/\\N\[(\d+)\]/g, (match, key) => {
                    return withMark ? `<span style="color:blue;" title="${GameData.Actors[key]?.profile || ""}">${GameData.Actors[key]?.name || ""}</span>` : GameData.Actors[key]?.name;
                });
            }
            if (/\\K\[\d+\]/.test(str)) {
                str = str.replace(/\\K\[(\d+)\]/g, (match, key) => {
                    return withMark ? `<span style="color:blue;" title="${GameData.Actors[key]?.profile || ""}">${GameData.Actors[key]?.nickname || ""}</span>` : GameData.Actors[key]?.nickname;
                });
            }
            if (/\\M\[\d+\]/.test(str)) {
                str = str.replace(/\\M\[(\d+)\]/g, (match, key) => {
                    return withMark ? `<span style="color:green;" title="${GameData.Items[key]?.description || ""}">${GameData.Items[key]?.name || ""}</span>` : GameData.Items[key]?.name;
                });
            }
            if (/\\W\[\d+\]/.test(str)) {
                str = str.replace(/\\W\[(\d+)\]/g, (match, key) => {
                    if (!GameData?.CustomData?.[key]) return match;
                    return withMark ? `<span style="color:deeppink;">${GameData.CustomData[key] || ""}</span>` : GameData.CustomData[key];
                });
            }
            if (/\\C\[\d+\]/.test(str)) {
                str = str.replace(/\\C\[(\d+)\]/g, (match, key) => {
                    return ``;
                });
            }
            return str;
        }
    </script>
</body>

</html>