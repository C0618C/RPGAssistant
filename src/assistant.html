<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Maker æ¸¸æˆé€šç”¨åŠ©æ‰‹</title>
    <script type="text/javascript" src="/../GameTools/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="gameSetting.js"></script>
    <script type="text/javascript" src="modelwin.js"></script>
    <style>
        @font-face {
            font-family: 'GameFont';
            src: url('è†å—éº¦åœ†ä½“.ttf');
        }

        * {
            font-family: 'GameFont';
            font-size: 20px;
        }

        body {
            color: #fff;
            background-color: #000;
            padding: 0 0;
            margin: 0 0;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }

        #gameInfo {
            display: flex;
            flex-direction: row;
            height: 100%;
        }

        #gameInfo .col {
            height: auto;
            border: 1px solid darkred;
            flex: 1;
            max-width: 45vw;
        }

        .bar {
            width: 100%;
            height: 10px;
            background-color: #555;
            position: relative;
        }

        .barValue {
            height: 100%;
            background-color: #fff;
        }

        .barValueText {
            color: #fff;
            text-align: center;
            position: absolute;
            top: 0px;
            right: 1px;
        }

        .stateTag {
            float: left;
            border: 1px solid #fff;
            padding: 2px 5px;
            margin-right: 5px;
            cursor: pointer;
        }

        .box {
            border-top: 2px solid darkred;
            margin-top: 10px;
        }

        .box h5 {
            text-align: center;
        }

        #itemInfo,
        #armorsInfo,
        #weaponsInfo,
        #playerInfo {
            display: flex;
            flex-wrap: wrap;
            padding: 2px 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        #playerInfo div {
            padding: 2px 8px;
        }

        .item,
        .armor,
        .weapon {
            border: 1px solid darkblue;
            padding: 2px 5px;
            margin-right: 5px;
            cursor: pointer;
            border-radius: 5px;
            background-color: #eee;
            color: blueviolet;
            user-select: none;
        }

        .armor {
            color: rgb(149, 137, 8);
            border: 1px solid darkgreen;
        }

        .weapon {
            color: rgb(10, 149, 8);
            border: 1px solid darkgreen;
        }

        #toolsInfo {
            padding: 2px 8px;
            margin-bottom: 60px;
        }

        #toolsInfo button {
            color: darkred;
            font-size: 25px;
            padding: 5px 10px;
            margin: 5px 5px;
        }

        #switchesInfo .itemBox,
        #variablesInfo .itemBox {
            display: flex;
            flex-wrap: wrap;
            padding: 2px 15px;
            overflow-y: auto;
        }

        #switchesInfo,
        #variablesInfo {
            max-height: 89%;
            overflow-y: auto;
        }

        #dataChangeLog {
            overflow-x: auto;
        }

        #dataChangeLog>div {
            padding: 2px 8px;
        }

        .itemBox {
            border-top: 1px solid rgb(90, 8, 8);
            border-bottom: 1px solid rgb(90, 8, 8);
        }

        .topItem .item {
            border: 1px solid gold;
        }

        .col h4 {
            text-align: center;
        }

        .showAction {
            background-color: #000;
            color: #fff;
            margin: 5px 5px;
            box-shadow: 2px 2px 8px darkred;
        }

        .TopWin {
            position: absolute;
            top: 10%;
            left: 25%;
            width: 50vw;
            height: 80vh;
            border: 1px solid darkred;
            background-color: #000;
            display: none;
            box-shadow: 5px 5px 25px darkred;
        }

        .TopWin h3 {
            text-align: center;
            height: 40px;
            border-bottom: 1px solid darkred;
        }

        .TopWin #TopWinContent {
            padding: 10px 20px;
            display: flex;
            justify-content: center
        }

        .TopWin #TopWinContent button {
            font-size: 24px;
            padding: 10px 20px;
            background-color: darkred;
            color: white;
            border: none;
            cursor: pointer;
        }

        .TopWin #TopWinContent * {
            font-size: 24px;
        }

        .mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            position: fixed;
            display: none;
        }

        .checked::before {
            content: 'ğŸš©';
        }

        .questComplete {
            color: gray;
            text-decoration: line-through;
        }

        .questComplete::before {
            content: 'âœ…';
        }

        .questProcess {
            color: orange;
        }
    </style>
</head>

<body>
    <div id="loading" style="width: 100%;height: 100vh;display: flex;justify-content: center;align-items: center;">
        æ­£åœ¨æŸ¥æ‰¾æ¸¸æˆï¼Œè‹¥é•¿æœŸåœç•™æœ¬ç•Œé¢ï¼Œè¯·åˆ·æ–°æ¸¸æˆè¯•è¯•...</div>
    <div id="main" style="width: 100%;height: 100vh;display: none;">
        <h3 id="gameName"></h3>
        <div id="gameInfo">
            <!-- ç¬¬ä¸€åˆ— -->
            <div class="col" style="flex-grow: 0;flex-basis: min-content;overflow-y: auto;">
                <div id="actorInfo"></div>
                <div id="playerInfo" class="box" style="width: 400px;">
                    <div id="curMap">å½“å‰åœ°å›¾ï¼š</div>
                    <div id="coordinate">åæ ‡ï¼š</div><br />
                    <div id="gold" style="width: 100%;">ğŸª™é‡‘å¸ï¼š0</div>
                </div>
                <div class="box">
                    <h5>èƒŒåŒ…</h5>
                    <div id="itemInfo"></div>
                </div>
                <div class="box">
                    <h5>è£…å¤‡</h5>
                    <div id="weaponsInfo"></div>
                    <hr />
                    <div id="armorsInfo"></div>
                </div>
                <div class="box">
                    <div id="toolsInfo">
                        <button type="button" onclick="btGetItem()">è·å–ç‰©å“</button>
                        <button type="button" onclick="btGetWeapons()">è·å–æ­¦å™¨</button>
                        <button type="button" onclick="btGetArmors()">è·å–é˜²å…·</button>
                        <button type="button" onclick="btSetActorCount()">è§’è‰²æ•°é‡</button>
                        <button type="button" onclick="btSetPosition()">ç§»åŠ¨</button>
                        <button type="button" onclick="btSetScale()">ç¼©æ”¾</button>
                        <button type="button" onclick="btSetGold()">è·å¾—é‡‘å¸</button>
                        <button type="button">ä¹ å¾—æŠ€èƒ½</button>
                        <button type="button" onclick="btCheckQuests()">æŸ¥çœ‹ä»»åŠ¡</button>
                        <button type="button" onclick="btShowMapInfo()">
                            <span style="color:green;background-color: lightskyblue;">ğŸ—º</span>ä¸–ç•Œåœ°å›¾
                        </button>
                        <button type="button" onclick="btShowEvents()">æŸ¥çœ‹å½“å‰åœ°å›¾äº¤äº’ç‚¹</button>
                        <button type="button" onclick="btActiveEvents()" title="å°†å½“å‰æˆ¿é—´ä¸­ç”±Switchæ§åˆ¶çš„äº¤äº’ç‚¹è®¾ç½®ä¸ºæ¿€æ´»ï¼Œå¸¸è§äºå›æƒ³æˆ¿é—´ä¸­æ¿€æ´»æ‰€æœ‰å›æƒ³">æ¿€æ´»å½“å‰æˆ¿é—´äº¤äº’ç‚¹</button>
                        <button type="button" onclick="btRegisterChange()">ç™»è®°æ•°æ®å˜æ›´</button>
                        <button type="button" onclick="btToggleLog()">æŸ¥çœ‹æ•°æ®æ—¥å¿—</button>
                    </div>
                </div>
            </div>
            <div class="col" style="display: none;" id="changeLog">
                <h4>æ•°æ®å˜æ›´æ—¥å¿—</h4>
                <div id="dataChangeLog"></div>
            </div>
            <div class="col">
                <h4>å˜é‡</h4>
                <div id="variablesInfo"></div>
            </div>
            <div class="col">
                <h4>å¼€å…³</h4>
                <div id="switchesInfo"></div>
            </div>
        </div>
    </div>

    <div class="mask"></div>
    <div id="TopWin" class="TopWin">
        <div style="float:right;margin-top:15px;margin-right: 15px;font-size: 25px;cursor: pointer;"
            onclick="HideTopWin()">Ã—</div>
        <h3 id="TopWinTitle">çª—å£æ ‡é¢˜</h3>
        <div id="TopWinContent"></div>
    </div>

    <script type="template" id="actorInfoTemplate">
        <div id="baseInfo_${actorIndex}" style="margin-bottom: 20px;">
            <div>
                <div id="actorLevel_${actorIndex}" style="float: right;margin-right:20px;cursor:pointer" onclick="btLevelUp(${actorId})"></div>
                <div id="actorName_${actorIndex}" style="font-size:25px;"></div>
            </div>
            <table class="actorInfoTable">
                <tr>
                    <td>&nbsp;HPï¼š</td>
                    <td class="bar">
                        <div class="barValue" id="hp_${actorIndex}" style="background-color: red;"></div>
                        <div class="barValueText" id="hpTxt_${actorIndex}"></div>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;MPï¼š</td>
                    <td class="bar">
                        <div class="barValue" id="mp_${actorIndex}" style="background-color: blue;"></div>
                        <div class="barValueText" id="mpTxt_${actorIndex}"></div>
                    </td>
                </tr>
                <tr>
                    <td>&nbsp;EXPï¼š</td>
                    <td class="bar">
                        <div class="barValue" id="exp_${actorIndex}" style="background-color: green;"></div>
                        <div class="barValueText" id="expTxt_${actorIndex}"></div>
                    </td>
                </tr>
                <tr>
                    <td>çŠ¶æ€:</td>
                    <td id="actorStates_${actorIndex}"></td>
                </tr>
            </table>
        </div>
    </script>
    <script type="text/javascript">
        // å…¨å±€ç³»ç»Ÿå˜é‡
        let GameId = null;
        let GameName = null;
        let GameData = null;        //æ¸¸æˆä¸­$datakå¼€å¤´çš„æ•°æ®
        let GameCacheData = {};        //æ¸¸æˆåŠ¨æ€æ•°æ®æœ€æ–°ç‰ˆæœ¬ç¼“å­˜
        let _stateSelectGame = false;
        // æ˜¾ç¤ºåœ¨é¡¶éƒ¨çš„å˜é‡å’Œå¼€å…³
        let DataShowTop = {
            var: new Set(),
            switch: new Set()
        };

        // æ•°æ®å˜æ›´æ—¥å¿—ç›¸å…³
        let DataChangeSetting = {};
        let DataChangeLog = createObservableArray([], RenderDataChangeLog);

        // ç¼©æ”¾é€‰é¡¹
        const SCALE_OPTIONS = [
            { value: 1.0, label: "100%" },
            { value: 1.25, label: "125%" },
            { value: 1.5, label: "150%", selected: "selected" },
            { value: 2.0, label: "200%" },
            { value: 2.15, label: "215%" },
            { value: 2.25, label: "225%" },
            { value: 2.5, label: "250%" }
        ];

        function SetGame(gameid, gamename) {
            GameId = gameid;
            GameName = gamename;
            _stateSelectGame = true;
            DataChangeSetting = {};
            HideTopWin();
            console.log("å·²è½½å…¥æ¸¸æˆï¼š", GameName)
        }
        //ç³»ç»ŸçŠ¶æ€

        //è¿æ¥æ¸¸æˆ
        function ConnectGame() {
            if (GameId) {
                InitGame();
                return;
            }
            socketClient.emit("CHECK", "check");
            if (!_stateSelectGame) setTimeout(() => {
                ConnectGame();
            }, 1000);
        }

        // é€‰æ‹©æ¸¸æˆ
        function SelectGame(data) {
            if (data.gameList.length === 1) {
                SetGame(data.gameList[0].id, data.gameList[0].name)
                return;
            }
            //é€‰æ¸¸æˆçš„ç•Œé¢
            let dom = $("<style>ul{list-style-type:none;padding:0px;margin:0px;} ul li:hover{background-color:darkred;}</style><ul></ul>");
            for (let i = 0; i < data.gameList.length; i++) {
                dom.append($(`<li onclick=\"SetGame('${data.gameList[i].id}','${data.gameList[i].name}')\" style="cursor:pointer;padding:20px 20px;">${data.gameList[i].name} â€”â€” ${data.gameList[i].id}</li>`));
            }
            ShowTopWin("é€‰æ‹©æ¸¸æˆ", dom);
        }

        //åˆå§‹åŒ–æ¸¸æˆ
        function InitGame() {
            $("#loading").hide();
            $("#main").show();
            $("#gameName").text(GameName);

            if (!GameData) {//åˆå§‹åŒ–æ•°æ®
                GameData = {};
                GetData("Variables", { handleType: "Cache" }, { varName: "$dataSystem.variables" });
                GetData("Switches", { handleType: "Cache" }, { varName: "$dataSystem.switches" });
                GetData("States", { handleType: "Cache" }, { varName: "$dataStates" });
                GetData("Items", { handleType: "Cache" }, { varName: "$dataItems" });
                GetData("Weapons", { handleType: "Cache" }, { varName: "$dataWeapons" });
                GetData("Armors", { handleType: "Cache" }, { varName: "$dataArmors" });
                GetData("Quests", { handleType: "Cache" }, { varName: "$dataQuests" });
                GetData("Actors", { handleType: "Cache" }, { varName: "$dataActors" });
                GetData("CustomData", { handleType: "Cache" }, { varName: "CustomData" });//æ¸¸æˆä¸ªæ€§åŒ–æ•°æ®
                GetData("MapInfos", { handleType: "Cache" }, { varName: "$dataMapInfos" });
                setTimeout(Update, 1000);
            }
        }

        function Update() {
            GetData("Actor", { format: ACTOR_DATA_FORMAT }, { count: ACTOR_COUNT });
            GetData("Item");
            GetData("Armor");
            GetData("Weapon");
            GetData("Gold");
            // GetData("Player");
            GetData("Coordinate");
            GetData("Variables");
            GetData("Switches");
            GetData("CurMapId", undefined, { varName: "$gameMap._mapId" });
            requestAnimationFrame(Update);
        }

        function EndGame(gameName) {
            if (gameName !== GameName) return;
            console.log("æ¸¸æˆä¸‹çº¿ï¼š", GameName);
            $("#loading").show();
            $("#main").hide();
            HideTopWin();
            GameId = null;
            GameName = null;
            GameData = null;
            GameCacheData = {};
            DataShowTop.var.clear();
            DataShowTop.switch.clear();
            ConnectGame();
        }

        (function () {
            let socketClient = io();
            window.socketClient = socketClient;

            socketClient.on("GameEnd", (data) => {
                EndGame(data);
            });
            socketClient.on("CHECK_Result", (data) => {
                SelectGame(data);
            });
            socketClient.on("Answer_Data", (data) => {
                RenderData(data);
            });
            ConnectGame();
        })();

        /**
         * è·å–æ•°æ®
         * @param {string} dataName æ•°æ®åç§°
         * @param {object} options é€‰é¡¹
         * @param {string} options.handleType å¤„ç†æ•°æ®çš„æ–¹å¼ï¼ŒRenderï¼šæ¸²æŸ“æ•°æ®ï¼ŒCacheï¼šç¼“å­˜æ•°æ®
         * @param {string} options.key æ•°æ®æ ‡è¯†ï¼Œä»…ç”¨äºUIåŒºåˆ†æ•°æ®ç±»å‹ï¼Œå¦‚"cache"åˆ™æ‰§è¡Œæ•°æ®ç¼“å­˜ã€‚
         * @param {string} options.format è·å–æ•°æ®çš„æ ¼å¼/é€”å¾„
         */
        function GetData(dataName, { handleType, key, format, cache } = { handleType: "Render", key: "", cache: true }, defaultData = {}) {
            if (cache !== false) cache = true;
            let data = {
                gameId: GameId,
                action: "GetData",
                type: dataName,
                handleType: handleType,    //å¤„ç†æ•°æ®çš„æ–¹å¼ï¼ŒRenderï¼šæ¸²æŸ“æ•°æ®ï¼ŒCacheï¼šç¼“å­˜æ•°æ®
                format: format,          //è·å–æ•°æ®çš„æ ¼å¼/é€”å¾„
                key: key,                    //æ•°æ®æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†åŒç±»å‹ã€ä¸åŒæ ¼å¼çš„æ•°æ®
                cache: cache,       //UIæ˜¯å¦ç¼“å­˜æ•°æ®
                ...defaultData
            };

            window.socketClient.emit("Ask_Data", data);
        }

        function ExecCMD(data) {
            let cmd = {
                ...data
            }
            window.socketClient.emit("ExecCMD", cmd);
        }

        function MoveTo(x, y, mapId = null) {
            if (!mapId) ExecCMD({
                cmd: "Move",
                type: "Position",
                x: x,
                y: y,
            });
            else ExecCMD({
                cmd: "Transfer",
                type: "NewMap",
                id: mapId,
                x: x,
                y: y,
                direction: 0,
                fadeType: 0,
            });
        }

        /**
         * æ›´æ–°UIâ€”â€”æ¸²æŸ“æ•°æ®
         * @param {object} data æ•°æ®
         */
        function RenderData(data) {
            if (data.handleType === "Cache") return CacheData(data);//ä»…éœ€ç¼“å­˜æ•°æ®ï¼Œæ— éœ€æ¸²æŸ“

            let oldData = [];
            //æ£€æŸ¥ç¼“å­˜
            if (data.cache) {
                let cacheData = JSON.stringify(data.data);
                if (GameCacheData[data.type] === cacheData) return;//æ•°æ®æœªæ”¹å˜ï¼Œæ— éœ€æ¸²æŸ“
                oldData = JSON.parse(GameCacheData[data.type] || "[]");
                GameCacheData[data.type] = cacheData;//æ›´æ–°ç¼“å­˜
            }

            if (!data.data && !data.err) return;
            switch (data.type) {
                case "Actor":
                    RenderActor(data.data);
                    break;
                case "Item":
                    RenderItem(data.data);
                    break;
                case "Armor":
                    RenderArmor(data.data);
                    break;
                case "Weapon":
                    RenderWeapon(data.data);
                    break;
                case "Gold":
                    $("#gold").text(`ğŸª™é‡‘å¸ï¼š${data.data || 0}`);
                    break;
                case "Coordinate":
                    $("#coordinate").text(`åæ ‡ï¼š(${data.data.x},${data.data.y})`);
                    break;
                case "Variables":
                    RenderVariables(data.data, oldData);
                    break;
                case "Switches":
                    RenderSwitches(data.data, oldData);
                    break;
                case "CurEvents":
                    ShowCurEvents(data.data);
                    break;
                case "Quests":
                    ShowQuests(data.data, data.err);
                    break;
                case "MapInfos":
                    ShowMapInfo(data.data);
                    break;
                case "CurMapId":
                    RenderCurMapInfo(data.data);
                    break;
            }
        }

        /**
         * æ¸²æŸ“è§’è‰²æ•°æ®
         * @param {object} data è§’è‰²æ•°æ®
         */
        function RenderActor(data) {
            if (!data) return;

            let template = $("#actorInfoTemplate").html();
            // console.log(template);

            let actorPlant = $("#actorInfo");
            actorPlant.empty();

            for (let i = 0; i < data.length; i++) {
                let data_i = data[i];
                if (!data_i) continue;
                let actorHtml = $(template.replace(/\${actorIndex}/g, i).replace(/\${actorId}/g, data_i._actorId));

                actorHtml.find(`#actorName_${i}`).text("ã€€" + data_i._name);
                actorHtml.find(`#actorLevel_${i}`).text(`Lv.${data_i._level}`);
                actorHtml.find(`#hp_${i}`).css("width", `${data_i._hp / data_i.mhp * 100}%`);
                actorHtml.find(`#mp_${i}`).css("width", `${data_i._mp / data_i.mmp * 100}%`);
                actorHtml.find(`#exp_${i}`).css("width", `${data_i._exp / data_i._maxExp * 100}%`);
                actorHtml.find(`#hpTxt_${i}`).text(`${data_i._hp}/${data_i.mhp}`);
                actorHtml.find(`#mpTxt_${i}`).text(`${data_i._mp}/${data_i.mmp}`);
                actorHtml.find(`#expTxt_${i}`).text(`${data_i._exp}/${data_i._maxExp}`);
                if (!data_i._maxExp) actorHtml.find(`#exp_${i}`).closest("tr").hide();

                //è®¾ç½®çŠ¶æ€
                if (data_i._states && GameData?.States) {
                    let stateBox = actorHtml.find(`#actorStates_${i}`);
                    for (let state of data_i._states) {
                        stateBox.append(`<div class="stateTag" title="${GameData.States[state].note}">${GameData.States[state].name}</div>`);
                    }
                }

                actorPlant.append(actorHtml);
            }
        }

        /**
         * æ¸²æŸ“ç‰©å“æ•°æ®
         * @param {object} data ç‰©å“æ•°æ®
         */
        function RenderItem(data) {
            let itemBag = $("#itemInfo");
            itemBag.empty();

            let bagHtml = "";
            for (let i = 0; i < data.length; i++) {
                let data_i = data[i];
                bagHtml += `<div class="item" title="${stringFormat(data_i.item.description, false)}_${data_i.item.note}">${data_i.item.name} x ${data_i.count}</div>`;
            }
            itemBag.html(bagHtml);
        }

        function RenderArmor(data) {
            let armorBag = $("#armorsInfo");
            armorBag.empty();

            let bagHtml = "";
            for (let i = 0; i < data.length; i++) {
                let data_i = data[i];
                bagHtml += `<div class="armor" title="${data_i.armor.description}_${data_i.armor.note}">${data_i.armor.name} x ${data_i.count}</div>`;
            }
            armorBag.html(bagHtml);
        }

        function RenderWeapon(data) {
            let armorBag = $("#weaponsInfo");
            armorBag.empty();

            let bagHtml = "";
            for (let i = 0; i < data.length; i++) {
                let data_i = data[i];
                bagHtml += `<div class="weapon" title="${data_i?.weapon?.description}_${data_i?.weapon?.note}">${data_i?.weapon?.name || ""} x ${data_i.count}</div>`;
            }
            armorBag.html(bagHtml);
        }

        function SetVarTop(i) {
            DataShowTop.var.add(i, i);
            let data = JSON.parse(GameCacheData.Variables || "[]");
            RenderVariables(data, data);
        }
        function SetVarTopDown(i) {
            DataShowTop.var.delete(i);
            let data = JSON.parse(GameCacheData.Variables || "[]");
            RenderVariables(data, data);
        }

        function RenderVariables(data, oldData) {
            if (!GameData?.Variables) return;
            let variablesBox = $("#variablesInfo");
            variablesBox.empty();
            let top = $("<div class='topItem itemBox'></div>");
            let itemBox = $("<div class='itemBox mainItemBox'></div>");

            let Variables = GameData.Variables;
            if (data.length > GameData.Variables.length)
                Variables = GameData.Variables.concat(new Array(data.length - GameData.Variables.length).fill("æœªè®¾å®šåå­—"));

            let bagHtml = "";
            for (let [i, v] of DataShowTop.var.entries()) {
                let css = '';
                if (oldData && !DataIsEqual(data[i], oldData[i])) { //æ•°æ®å˜æ›´
                    css = `style="background-color:darkred;"`;
                    if (DataChangeSetting.varAll || DataChangeSetting.v?.has(i)) {
                        DataChangeLog.push({ i, old: oldData[i], new: data[i], type: "å˜é‡" });
                    }
                }
                bagHtml += `<div class="item showAction" ${css} title="${i}" onclick="ClickVariable(${i},'${data[i]}')" oncontextmenu="SetVarTopDown(${i});return false;">${Variables[i]} ï¼š${data[i]}</div>`;
            }
            if (bagHtml != "") {
                variablesBox.append(top);
                top.html(bagHtml);
            }
            bagHtml = "";
            for (let i = 0; i < Variables.length; i++) {
                let v = Variables[i];
                if (!v && !data[i]) continue;
                let css = ``;
                if (DataShowTop.var.has(i)) continue;
                if (oldData && !DataIsEqual(data[i], oldData[i])) {
                    css = `style="background-color:darkred;"`;
                    if (DataChangeSetting.varAll || DataChangeSetting.v?.has(i)) {
                        DataChangeLog.push({ i, old: oldData[i], new: data[i], type: "å˜é‡" });
                    }
                }
                bagHtml += `<div class="item showAction" ${css} title="${i}" onclick="ClickVariable(${i},'${data[i]}')" oncontextmenu="SetVarTop(${i});return false;">${v} ï¼š${data[i]}</div>`;
            }
            itemBox.html(bagHtml);
            variablesBox.append(itemBox);
        }

        function SetSwitchTop(i) {
            DataShowTop.switch.add(i, i);
            let data = JSON.parse(GameCacheData.Switches || "[]");
            RenderSwitches(data, data);
        }
        function SetSwitchTopDown(i) {
            DataShowTop.switch.delete(i);
            let data = JSON.parse(GameCacheData.Switches || "[]");
            RenderSwitches(data, data);
        }
        function RenderSwitches(data, oldData) {
            if (!GameData?.Switches) return;
            let switchesBox = $("#switchesInfo");
            switchesBox.empty();
            let top = $("<div class='topItem itemBox'></div>");
            let itemBox = $("<div class='itemBox mainItemBox'></div>");

            let Switches = GameData.Switches;
            if (data.length > GameData.Switches.length)
                Switches = GameData.Switches.concat(new Array(data.length - GameData.Switches.length).fill("æœªè®¾å®šåå­—"));

            let bagHtml = "";
            for (let [i, v] of DataShowTop.switch.entries()) {
                let css = "";
                if (oldData && !DataIsEqual(data[i], oldData[i])) {
                    css = `style="background-color:darkred;"`;
                    if (DataChangeSetting.switchAll || DataChangeSetting.s?.has(i)) {
                        DataChangeLog.push({ i, old: oldData[i], new: data[i], type: "å¼€å…³" });
                    }
                }
                bagHtml += `<div class="item showAction" ${css} title="${i}" onclick="ClickSwitch(${i})" oncontextmenu="SetSwitchTopDown(${i});return false;"><b>${Switches[i]} ï¼š${data[i]}</b></div>`;
            }
            if (bagHtml != "") {
                switchesBox.append(top);
                top.html(bagHtml);
            }
            bagHtml = "";
            for (let i = 0; i < Switches.length; i++) {
                let v = Switches[i];
                if (!v && !data[i]) continue;
                let css = ``;
                if (DataShowTop.switch.has(i)) continue;
                if (oldData && !DataIsEqual(data[i], oldData[i])) {
                    css = `style="background-color:darkred;"`;
                    if (DataChangeSetting.switchAll || DataChangeSetting.s?.has(i)) {
                        DataChangeLog.push({ i, old: oldData[i], new: data[i], type: "å¼€å…³" });
                    }
                }
                bagHtml += `<div class="item showAction" ${css} title="${i}" onclick="ClickSwitch(${i})" oncontextmenu="SetSwitchTop(${i});return false;"><b>${v} ï¼š${data[i]}</b></div>`;
            }
            itemBox.html(bagHtml);
            switchesBox.append(itemBox);
        }

        /**
         * æ¸²æŸ“å½“å‰åœ°å›¾åç§°
         * @param {number} mapId åœ°å›¾ID
         */
        function RenderCurMapInfo(mapId) {
            let mapUrl = [];
            let curMap = GameData.MapInfos[mapId];
            mapUrl.push(curMap.name);

            while (GameData.MapInfos[curMap.parentId]) {
                curMap = GameData.MapInfos[curMap.parentId];
                mapUrl.unshift(curMap.name);
            }

            $("#curMap").text(`å½“å‰åœ°å›¾ï¼š${mapUrl.join("/")}`);
        }

        /**
         * ç¼“å­˜æ•°æ®
         * @param {object} data ç¼“å­˜æ•°æ®
         */
        function CacheData(data) {
            GameData[data.type] = data.data;
        }

        /**
         * ç‚¹å‡»è®¾ç½®æ¸¸æˆå˜é‡
         * @param {number} index å˜é‡ç´¢å¼•
         * @param {string} data å˜é‡å€¼
         */
        function ClickVariable(index, data) {
            SetGameValue({
                id: index,
                name: GameData.Variables[index],
                value: data,
                type: "Variable",
                showType: "æ¸¸æˆå˜é‡",
            })
        }

        /**
         * ç‚¹å‡»è®¾ç½®çŠ¶æ€å¼€å…³
         * @param {number} index å¼€å…³ç´¢å¼•
         * @param {boolean} data å¼€å…³çŠ¶æ€
         */
        function ClickSwitch(index, data) {
            SetGameValue({
                id: index,
                name: GameData.Switches[index],
                value: data,
                type: "Switch",
                showType: "çŠ¶æ€å¼€å…³",
            })
        }

        /**
         * å‡çº§è§’è‰²
         * @param {number} actorIndex è§’è‰²ç´¢å¼•
         */
        function btLevelUp(actorIndex) {
            let actor = GameData.Actors[actorIndex];
            if (!actor) return;

            ExecCMD({
                cmd: "LevelUp",
                type: "Actor",
                id: actorIndex,
            });
        }

        function btToggleLog() {
            $("div#changeLog").toggle();
        }

        /**
         * æ ¼å¼åŒ–å­—ç¬¦ä¸²--ä¸æ¸¸æˆå†…ç½®æ ¼å¼å…³è”
         * @param {string} str å­—ç¬¦ä¸²
         * @param {boolean} withMark æ˜¯å¦æ·»åŠ æ ‡è®°
         * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
         */
        function stringFormat(str, withMark = true) {
            if (/\\N\[\d+\]/.test(str)) {
                str = str.replace(/\\N\[(\d+)\]/g, (match, key) => {
                    return withMark ? `<span style="color:blue;" title="${GameData.Actors[key]?.profile || ""}">${GameData.Actors[key]?.name || ""}</span>` : GameData.Actors[key]?.name;
                });
            }
            if (/\\K\[\d+\]/.test(str)) {
                str = str.replace(/\\K\[(\d+)\]/g, (match, key) => {
                    return withMark ? `<span style="color:blue;" title="${GameData.Actors[key]?.profile || ""}">${GameData.Actors[key]?.nickname || ""}</span>` : GameData.Actors[key]?.nickname;
                });
            }
            if (/\\M\[\d+\]/.test(str)) {
                str = str.replace(/\\M\[(\d+)\]/g, (match, key) => {
                    return withMark ? `<span style="color:green;" title="${GameData.Items[key]?.description || ""}">${GameData.Items[key]?.name || ""}</span>` : GameData.Items[key]?.name;
                });
            }
            if (/\\W\[\d+\]/.test(str)) {
                str = str.replace(/\\W\[(\d+)\]/g, (match, key) => {
                    if (!GameData?.CustomData?.[key]) return match;
                    return withMark ? `<span style="color:deeppink;">${GameData.CustomData[key] || ""}</span>` : GameData.CustomData[key];
                });
            }
            if (/\\C\[\d+\]/.test(str)) {
                str = str.replace(/\\C\[(\d+)\]/g, (match, key) => {
                    return ``;
                });
            }
            return str;
        }

        function RenderDataChangeLog(data, type) {
            if (type == "clean") {
                $("#dataChangeLog").html();
                return;
            }
            data.forEach(item => {
                let name = item.type == "å˜é‡" ? GameData.Variables[item.i] : GameData.Switches[item.i];
                $("#dataChangeLog").prepend(`<div>[${new Date().toLocaleString()}]ï¼š${item.type} <span style="color:red;">${name}</span> ç”±ã€${item.old}ã€‘å˜æ›´ä¸ºã€${item.new}ã€‘</div>`);
            });
        }
        function DataIsEqual(data1, data2) {
            if (typeof data1 != typeof data2) return false;
            if (Array.isArray(data1)) {
                return ArrayIsEqual(data1, data2);
            }
            return data1 == data2;
        }
        function ArrayIsEqual(arr1, arr2) {
            if (arr1.length != arr2.length) return false;
            return JSON.stringify(arr1) == JSON.stringify(arr2);
        }
    </script>
</body>

</html>